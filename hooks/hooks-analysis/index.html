<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/react-guidebook/umi.css" />
    <script>
      window.routerBase = "/react-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>useState 源码分析</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/react-guidebook//">React Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/react-guidebook//foundation">基础</a><a href="/react-guidebook//architect">架构</a><a href="/react-guidebook//ecosystem">生态</a><a href="/react-guidebook//api-reference">API</a><a aria-current="page" class="active" href="/react-guidebook//hooks">Hooks</a><a href="/react-guidebook//extensions">Extensions</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/react-guidebook//"></a><h1>React Guidebook</h1><p>React 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/react-guidebook//foundation">基础</a></li><li><a href="/react-guidebook//architect">架构</a></li><li><a href="/react-guidebook//ecosystem">生态</a></li><li><a href="/react-guidebook//api-reference">API</a></li><li><a aria-current="page" class="active" href="/react-guidebook//hooks">Hooks</a></li><li><a href="/react-guidebook//extensions">Extensions</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/react-guidebook//hooks">Hooks</a><ul><li><a href="/react-guidebook//hooks"><span>Hooks</span></a></li><li><a aria-current="page" class="active" href="/react-guidebook//hooks/hooks-analysis"><span>useState 源码分析</span></a></li><li><a href="/react-guidebook//hooks/hooks-faq"><span>FAQ</span></a></li></ul></li><li><a href="/react-guidebook//hooks/basic">基础 Hook</a><ul><li><a href="/react-guidebook//hooks/basic/use-state"><span>useState</span></a></li><li><a href="/react-guidebook//hooks/basic/use-effect"><span>useEffect</span></a></li><li><a href="/react-guidebook//hooks/basic/use-context"><span>useContext</span></a></li></ul></li><li><a href="/react-guidebook//hooks/extra">额外的 Hook</a><ul><li><a href="/react-guidebook//hooks/extra/use-reducer"><span>useReducer</span></a></li><li><a href="/react-guidebook//hooks/extra/use-callback"><span>useCallback</span></a></li><li><a href="/react-guidebook//hooks/extra/use-memo"><span>useMemo</span></a></li><li><a href="/react-guidebook//hooks/extra/use-ref"><span>useRef</span></a></li><li><a href="/react-guidebook//hooks/extra/use-imperative-handle"><span>useImperativeHandle</span></a></li><li><a href="/react-guidebook//hooks/extra/use-layout-effect"><span>useLayoutEffect</span></a></li><li><a href="/react-guidebook//hooks/extra/use-debug-value"><span>useDebugValue</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="前置知识" data-depth="2" class=""><a href="/react-guidebook//hooks/hooks-analysis#前置知识"><span>前置知识</span></a></li><li title="函数组件和类组件" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#函数组件和类组件"><span>函数组件和类组件</span></a></li><li title="React Fiber" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#react-fiber"><span>React Fiber</span></a></li><li title="React 渲染器与 setState" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#react-渲染器与-setstate"><span>React 渲染器与 setState</span></a></li><li title="了解 useState" data-depth="2" class=""><a href="/react-guidebook//hooks/hooks-analysis#了解-usestate"><span>了解 useState</span></a></li><li title="引入和触发更新" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#引入和触发更新"><span>引入和触发更新</span></a></li><li title="示例分析" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#示例分析"><span>示例分析</span></a></li><li title="核心步骤分析" data-depth="2" class=""><a href="/react-guidebook//hooks/hooks-analysis#核心步骤分析"><span>核心步骤分析</span></a></li><li title="Hook 对象" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#hook-对象"><span>Hook 对象</span></a></li><li title="renderWithHooks" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#renderwithhooks"><span>renderWithHooks</span></a></li><li title="总结" data-depth="2" class=""><a href="/react-guidebook//hooks/hooks-analysis#总结-1"><span>总结</span></a></li><li title="使用原则" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#使用原则"><span>使用原则</span></a></li><li title="为什么不能在循环/条件语句中执行" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#为什么不能在循环条件语句中执行"><span>为什么不能在循环/条件语句中执行</span></a></li><li title="为什么只能在函数组件中使用 hooks" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#为什么只能在函数组件中使用-hooks"><span>为什么只能在函数组件中使用 hooks</span></a></li><li title="useState 整体运作流程总结" data-depth="3" class=""><a href="/react-guidebook//hooks/hooks-analysis#usestate-整体运作流程总结"><span>useState 整体运作流程总结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="usestate-源码分析"><a aria-hidden="true" href="#usestate-源码分析"><span class="icon icon-link"></span></a>useState 源码分析</h1><p>从源码剖析 <code>useState</code> 的执行过程</p><p>示例代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import React, { useState } from &#x27;react&#x27;
import &#x27;./App.css&#x27;

export default function App() {

  const [count, setCount] = useState(0);
  const [name, setName] = useState(&#x27;Star&#x27;);

  // 调用三次setCount便于查看更新队列的情况
  const countPlusThree = () =&gt; {
    setCount(count+1);
    setCount(count+2);
    setCount(count+3);
  }
  return (
    &lt;div className=&#x27;App&#x27;&gt;
      &lt;p&gt;{name} Has Clicked &lt;strong&gt;{count}&lt;/strong&gt; Times&lt;/p&gt;
      &lt;button onClick={countPlusThree}&gt;Click *3&lt;/button&gt;
    &lt;/div&gt;
  )
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">import</span><span class="token plain"> React</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> useState </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token string">&#x27;./App.css&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">count</span><span class="token punctuation">,</span><span class="token plain"> setCount</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"> setName</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#x27;Star&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 调用三次setCount便于查看更新队列的情况</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">countPlusThree</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">className</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">App</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">name</span><span class="token punctuation">}</span><span class="token plain"> Has Clicked </span><span class="token tag punctuation">&lt;</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token plain"> Times</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">countPlusThree</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain">Click </span><span class="token operator">*</span><span class="token number">3</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>代码非常简单，点击 <code>button</code> 使 <code>count+3</code>，<code>count</code> 的值会显示在屏幕上。</p><h2 id="前置知识"><a aria-hidden="true" href="#前置知识"><span class="icon icon-link"></span></a>前置知识</h2><h3 id="函数组件和类组件"><a aria-hidden="true" href="#函数组件和类组件"><span class="icon icon-link"></span></a>函数组件和类组件</h3><blockquote><p>本节参考：<a href="https://overreacted.io/how-are-function-components-different-from-classes/" target="_blank" rel="noopener noreferrer">How Are Function Components Different from Classes?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>本节主要概念：</p><ul><li>函数组件和类组件的区别</li><li>React 如何区分这两种组件</li></ul><p>我们来看一个简单的 <code>Greeting</code> 组件，它支持定义成类和函数两种性质。在使用它时，不用关心他是如何定义的。</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 是类还是函数 —— 无所谓
&lt;Greeting /&gt;  // &lt;p&gt;Hello&lt;/p&gt;
" data-status="copy"></button><div class="token-line"><span class="token comment">// 是类还是函数 —— 无所谓</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Greeting</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain">  </span><span class="token comment">// &lt;p&gt;Hello&lt;/p&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果 <code>Greeting</code> 是一个函数，React 需要调用它：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// Greeting.js
function Greeting() {
  return &lt;p&gt;Hello&lt;/p&gt;;
}

// React 内部
const result = Greeting(props); // &lt;p&gt;Hello&lt;/p&gt;
" data-status="copy"></button><div class="token-line"><span class="token comment">// Greeting.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">Greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hello</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">Greeting</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// &lt;p&gt;Hello&lt;/p&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>但如果 <code>Greeting</code> 是一个类，React 需要先将其实例化，再调用刚才生成实例的 <code>render</code> 方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// Greeting.js
class Greeting extends React.Component {
  render() {
    return &lt;p&gt;Hello&lt;/p&gt;;
  }
}

// React 内部
const instance = new Greeting(props);  // Greeting {}
const result = instance.render();      // &lt;p&gt;Hello&lt;/p&gt;
" data-status="copy"></button><div class="token-line"><span class="token comment">// Greeting.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Greeting</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hello</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Greeting</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain">  </span><span class="token comment">// Greeting {}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain">      </span><span class="token comment">// &lt;p&gt;Hello&lt;/p&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>React 通过以下方式来判断组件的类型：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// React 内部
class Component {}
Component.prototype.isReactComponent = {};

// 检查方式
class Greeting extends React.Component {}
console.log(Greeting.prototype.isReactComponent); // {}

" data-status="copy"></button><div class="token-line"><span class="token comment">// React 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">isReactComponent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 检查方式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Greeting</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token class-name">Greeting</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">isReactComponent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// {}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="react-fiber"><a aria-hidden="true" href="#react-fiber"><span class="icon icon-link"></span></a>React Fiber</h3><blockquote><p>本节参考：<a href="https://www.youtube.com/watch?v=ZCuYPiUIONs&amp;list=PLb0IAmt7-GS3fZ46IGFirdqKTIxlws7e0&amp;index=5" target="_blank" rel="noopener noreferrer">A cartoon intro to fiber<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>本节主要概念（了解即可）：</p><ul><li>React 现在的渲染都是由 Fiber 来调度</li><li>Fiber 调度过程中的两个阶段（以 Render 为界）</li></ul><p><strong>Fiber</strong>（可译为丝）比线程还细的控制粒度，是 React16 中的新特性，旨在对渲染过程做更精细的调整。</p><p>产生原因：</p><ol><li>Fiber 之前的 <code>reconciler</code>（被称为 Stack reconciler）自顶向下的递归 <code>mount/update</code>，无法中断（持续占用主线程），这样主线程上的布局、动画等周期性任务以及交互响应就无法立即得到处理，影响体验</li><li>渲染过程中没有优先级可言</li></ol><p>React Fiber 的方式：</p><p>把一个耗时长的任务分成很多小片，每一个小片的运行时间很短，虽然总时间依然很长，但是在每个小片执行完之后，都给其他任务一个执行的机会，这样唯一的线程就不会被独占，其他任务依然有运行的机会。</p><p>React Fiber 把更新过程碎片化，执行过程如下面的图所示，每执行完一段更新过程，就把控制权交还给 React 负责任务协调的模块，看看有没有其他紧急任务要做，如果没有就继续去更新，如果有紧急任务，那就去做紧急任务。 维护每一个分片的数据结构，就是 Fiber。</p><p>有了分片之后，更新过程的调用栈如下图所示，中间每一个波谷代表深入某个分片的执行过程，每个波峰就是一个分片执行结束交还控制权的时机。让线程处理别的事情</p></div><img alt="Fiber示意图" src="/react-guidebook/static/fiber-example.e199a78d.png" width="540"/><div class="markdown"><p>Fiber 的调度过程分为以下两个阶段：</p><p><code>render/reconciliation</code> 阶段 — 里面的所有生命周期函数都可能被执行多次，所以尽量保证状态不变</p><ul><li><code>componentWillMount</code></li><li><code>componentWillReceiveProps</code></li><li><code>shouldComponentUpdate</code></li><li><code>componentWillUpdate</code></li></ul><p><code>Commit</code> 阶段 — 不能被打断，只会执行一次</p><ul><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>compoenntWillunmount</code></li></ul><p>Fiber 的增量更新需要更多的上下文信息，之前的 VirtualDOM Tree 显然难以满足，所以扩展出了 Fiber Tree（即 Fiber 上下文的 VirtualDOM Tree），更新过程就是根据输入数据以及现有的 Fiber Tree 构造出新的 Fiber Tree（<code>workInProgress tree</code>）。</p><p>与 Fiber 有关的所有代码位于 <a href="https://github.com/facebook/react/tree/v16.8.6/packages/react-reconciler" target="_blank" rel="noopener noreferrer">packages/react-reconciler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中，一个 Fiber 节点的详细定义如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function FiberNode(
  tag: WorkTag,
  pendingProps: mixed,
  key: null | string,
  mode: TypeOfMode,
) {
  // Instance
  this.tag = tag;
  this.key = key;
  this.elementType = null;
  this.type = null;
  this.stateNode = null;

  // Fiber
  this.return = null;
  this.child = null;
  this.sibling = null;
  this.index = 0;
  this.ref = null;
  this.pendingProps = pendingProps;
  this.memoizedProps = null;
  this.updateQueue = null;

  // 重点
  this.memoizedState = null;

  this.contextDependencies = null;
  this.mode = mode;

  // Effects
  /** 细节略 **/
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">FiberNode</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">tag</span><span class="token parameter punctuation">:</span><span class="token parameter"> WorkTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  pendingProps</span><span class="token parameter punctuation">:</span><span class="token parameter"> mixed</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  key</span><span class="token parameter punctuation">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  mode</span><span class="token parameter punctuation">:</span><span class="token parameter"> TypeOfMode</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Instance</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> tag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Fiber</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">return</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">index</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 重点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">contextDependencies</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> mode</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Effects</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token doc-comment comment"> /** 细节略 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>我们只关注一下 <code>this.memoizedState</code>。</p><p>这个 <code>key</code> 用来存储在上次渲染过程中最终获得的节点的 <code>state</code>，每次 <code>render</code> 之前，React 会计算出当前组件最新的 <code>state</code> 然后赋值给组件，再执行 <code>render</code>。类组件和使用 <code>useState</code> 的函数组件均适用。</p><p>记住上面这句话，后面还会经常提到 <code>memoizedState</code>。</p><blockquote><p>有关 Fiber 每个 key 的具体含义可以参见 <a href="https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiber.js#L84-L218" target="_blank" rel="noopener noreferrer">源码的注释<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><h3 id="react-渲染器与-setstate"><a aria-hidden="true" href="#react-渲染器与-setstate"><span class="icon icon-link"></span></a>React 渲染器与 setState</h3><blockquote><p>本节参考： <a href="https://overreacted.io/how-does-setstate-know-what-to-do/" target="_blank" rel="noopener noreferrer">How Does setState Know What to Do?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>本节主要概念：</p><ul><li>React 渲染器是什么</li><li>setState 为什么能够触发更新</li></ul><p>由于 React 体系的复杂性以及目标平台的多样性。<code>react</code> 包只暴露一些定义组件的 API。绝大多数 React 的实现都存在于 渲染器（renderers）中。</p><p><code>react-dom</code>、<code>react-dom/server</code>、 <code>react-native</code>、 <code>react-test-renderer</code>、 <code>react-art</code> 都是常见的渲染器</p><p>这就是为什么不管目标平台是什么，<code>react</code> 包都是可用的。从 <code>react</code> 包中导出的一切，比如 <code>React.Component</code>、<code>React.createElement</code>、 <code>React.Children</code> 和 <code>Hooks</code> 都是独立于目标平台的。无论运行 <code>React DOM</code>，还是 <code>React DOM Server</code>,或是 <code>React Native</code>，组件都可以使用同样的方式导入和使用。</p><p>所以当我们想使用新特性时，<code>react</code> 和 <code>react-dom</code> 都需要被更新。</p><blockquote><p>例如，当 React 16.3 添加了 Context API，<code>React.createContext()</code> API 会被 React 包暴露出来。</p><p>但是 <code>React.createContext()</code> 其实并没有实现 <code>context</code>。因为在 <code>React DOM</code> 和 <code>React DOM Server</code> 中同样一个 API 应当有不同的实现。所以 <code>createContext()</code> 只返回了一些普通对象：<strong>所以，如果你将 <code>react</code> 升级到了16.3+，但是不更新 <code>react-dom</code>，那么你就使用了一个尚不知道 <code>Provider</code> 和 <code>Consumer</code> 类型的渲染器。</strong>这就是为什么老版本的 <code>react-dom</code> 会报错说这些类型是无效的。</p></blockquote><p>这就是 <code>setState</code> 尽管定义在 React 包中，调用时却能够更新 DOM 的原因。它读取由 <code>React DOM</code> 设置的 <code>this.updater</code>，让 <code>React DOM</code> 安排并处理更新。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Component.setState = function(partialState, callback) {
  // setState 所做的一切就是委托渲染器创建这个组件的实例
  this.updater.enqueueSetState(this, partialState, callback, &#x27;setState&#x27;);
};
" data-status="copy"></button><div class="token-line"><span class="token maybe-class-name">Component</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// setState 所做的一切就是委托渲染器创建这个组件的实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token punctuation">.</span><span class="token method function property-access">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> partialState</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;setState&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>各个渲染器中的 <code>updater</code> 触发不同平台的更新渲染</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// React DOM 内部
const inst = new YourComponent();
inst.props = props;
inst.updater = ReactDOMUpdater;

// React DOM Server 内部
const inst = new YourComponent();
inst.props = props;
inst.updater = ReactDOMServerUpdater;

// React Native 内部
const inst = new YourComponent();
inst.props = props;
inst.updater = ReactNativeUpdater;
" data-status="copy"></button><div class="token-line"><span class="token comment">// React DOM 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> inst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOMUpdater</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React DOM Server 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> inst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOMServerUpdater</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React Native 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> inst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactNativeUpdater</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>至于 <code>updater</code> 的具体实现，就不是这里重点要讨论的内容了，下面让我们正式进入本文的主题：React Hooks。</p><h2 id="了解-usestate"><a aria-hidden="true" href="#了解-usestate"><span class="icon icon-link"></span></a>了解 useState</h2><h3 id="引入和触发更新"><a aria-hidden="true" href="#引入和触发更新"><span class="icon icon-link"></span></a>引入和触发更新</h3><p>本节主要概念：</p><ul><li><code>useState</code> 是如何被引入以及调用的</li><li><code>useState</code> 为什么能触发组件更新</li></ul><p>所有的 Hooks 在 React.js 中被引入，挂载在 React 对象中</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// React.js
import {
  useCallback,
  useContext,
  useEffect,
  useImperativeHandle,
  useDebugValue,
  useLayoutEffect,
  useMemo,
  useReducer,
  useRef,
  useState,
} from &#x27;./ReactHooks&#x27;;
" data-status="copy"></button><div class="token-line"><span class="token comment">// React.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useCallback</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useContext</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useEffect</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useImperativeHandle</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useDebugValue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useLayoutEffect</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useMemo</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useReducer</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useRef</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./ReactHooks&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>我们进入 ReactHooks.js 来看看，发现 <code>useState</code> 的实现竟然异常简单，只有短短两行</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactHooks.js
export function useState&lt;S&gt;(initialState: (() =&gt; S) | S) {
  const dispatcher = resolveDispatcher();
  return dispatcher.useState(initialState);
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> useState</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dispatcher </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> dispatcher</span><span class="token punctuation">.</span><span class="token method function property-access">useState</span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>看来重点都在这个 <code>dispatcher</code> 上，<code>dispatcher</code> 通过 <code>resolveDispatcher()</code> 来获取，这个函数同样也很简单，只是将 <code>ReactCurrentDispatcher.current</code> 的值赋给了 <code>dispatcher</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactHooks.js
function resolveDispatcher() {
  const dispatcher = ReactCurrentDispatcher.current;
  return dispatcher;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dispatcher </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> dispatcher</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>所以 <code>useState(xxx)</code> 等价于 <code>ReactCurrentDispatcher.current.useState(xxx)</code>。</p><p>看到这里，我们回顾一下第一章第三小节所讲的 React 渲染器与 <code>setState</code>，是不是发现有点似曾相识。</p><p>与 <code>updater</code> 是 <code>setState</code> 能够触发更新的核心类似，<code>ReactCurrentDispatcher.current.useState</code> 是 <code>useState</code>  能够触发更新的关键原因，这个方法的实现并不在<code>react</code> 包内。下面我们就来分析一个具体更新的例子。</p><h3 id="示例分析"><a aria-hidden="true" href="#示例分析"><span class="icon icon-link"></span></a>示例分析</h3><p>以全文开头给出的代码为例。</p><p>我们从 Fiber 调度的开始：<code>ReactFiberBeginwork</code> 来谈起</p><p>之前已经说过，React 有能力区分不同的组件，所以它会给不同的组件类型打上不同的 <code>tag</code>， 详见 <a href="https://github.com/facebook/react/blob/v16.8.6/packages/shared/ReactWorkTags.js" target="_blank" rel="noopener noreferrer">shared/ReactWorkTags.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>所以在 <code>beginWork</code> 的函数中，就可以根据 <code>workInProgess</code>（就是个 <code>Fiber</code> 节点）上的 <code>tag</code> 值来走不同的方法来加载或者更新组件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactFiberBeginWork.js
function beginWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderExpirationTime: ExpirationTime,
): Fiber | null {
  /** 省略与本文无关的部分 **/

  // 根据不同的组件类型走不同的方法
  switch (workInProgress.tag) {
    // 不确定组件
    case IndeterminateComponent: {
      const elementType = workInProgress.elementType;
      // 加载初始组件
      return mountIndeterminateComponent(
        current,
        workInProgress,
        elementType,
        renderExpirationTime,
      );
    }

    // 函数组件
    case FunctionComponent: {
      const Component = workInProgress.type;
      const unresolvedProps = workInProgress.pendingProps;
      const resolvedProps =
        workInProgress.elementType === Component
          ? unresolvedProps
          : resolveDefaultProps(Component, unresolvedProps);
      // 更新函数组件
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderExpirationTime,
      );
    }

    // 类组件
    case ClassComponent {
      /** 细节略 **/
    }
  }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactFiberBeginWork.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">current</span><span class="token parameter punctuation">:</span><span class="token parameter"> Fiber </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter punctuation">:</span><span class="token parameter"> Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  renderExpirationTime</span><span class="token parameter punctuation">:</span><span class="token parameter"> ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token doc-comment comment"> /** 省略与本文无关的部分 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 根据不同的组件类型走不同的方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 不确定组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">IndeterminateComponent</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> elementType </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 加载初始组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        elementType</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 函数组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponent</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 更新函数组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 类组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">ClassComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token doc-comment comment"> /** 细节略 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>下面我们来找出 <code>useState</code> 发挥作用的地方。</p><h4 id="第一次加载"><a aria-hidden="true" href="#第一次加载"><span class="icon icon-link"></span></a>第一次加载</h4><p><code>mount</code> 过程执行 <code>mountIndeterminateComponent</code> 时，会执行到 <code>renderWithHooks</code> 这个函数</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function mountIndeterminateComponent(
  _current,
  workInProgress,
  Component,
  renderExpirationTime,
) {

 /** 省略准备阶段代码 **/

  // value 就是渲染出来的 APP 组件
  let value;

  value = renderWithHooks(
    null,
    workInProgress,
    Component,
    props,
    context,
    renderExpirationTime,
  );
  /** 省略无关代码 **/
  }
  workInProgress.tag = FunctionComponent;
  reconcileChildren(null, workInProgress, value, renderExpirationTime);
  return workInProgress.child;
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">_current</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  Component</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  renderExpirationTime</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token doc-comment comment"> /** 省略准备阶段代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// value 就是渲染出来的 APP 组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> value</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    context</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    renderExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token doc-comment comment"> /** 省略无关代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>执行前：<code>nextChildren = value</code></p></div><img alt="执行前1" src="/react-guidebook/static/fiber-first-mount-1.5fdcac0d.png" width="640"/><div class="markdown"><p>执行后：<code>value = 组件的虚拟 DOM 表示</code></p></div><img alt="执行后1" src="/react-guidebook/static/fiber-first-mount-2.5fdcac0d.png" width="640"/><div class="markdown"><p>至于这个 <code>value</code> 是如何被渲染成真实的 DOM 节点，我们并不关心，<code>state</code> 值我们已经通过 <code>renderWithHooks</code> 取到并渲染。</p><h4 id="更新重渲染"><a aria-hidden="true" href="#更新重渲染"><span class="icon icon-link"></span></a>更新重渲染</h4><p>点击一下按钮：此时 <code>count</code> 从 0 变为 3。</p><p>更新过程执行的是 <code>updateFunctionComponent</code> 函数，同样会执行到 <code>renderWithHooks</code> 这个函数，我们来看一下这个函数执行前后发生的变化：</p><p><strong>执行前：</strong><code>nextChildren = undefined</code></p></div><img alt="执行前2" src="/react-guidebook/static/fiber-update-1.2f28b4fd.png" width="640"/><div class="markdown"><p><strong>执行后：</strong> <code>nextChildren = 更新后的组件的虚拟 DOM 表示</code></p></div><img alt="执行后2" src="/react-guidebook/static/fiber-update-2.435c4218.png" width="640"/><div class="markdown"><p>同样的，至于这个 <code>nextChildren</code> 是如何被渲染成真实的 DOM 节点，我们并不关心，最新的 <code>state</code> 值我们已经通过 <code>renderWithHooks</code> 取到并渲染。</p><p>所以，<code>renderWithHooks</code> 函数就是处理各种 <code>hooks</code> 逻辑的核心部分。</p><h2 id="核心步骤分析"><a aria-hidden="true" href="#核心步骤分析"><span class="icon icon-link"></span></a>核心步骤分析</h2><p><a href="https://github.com/facebook/react/blob/v16.8.6/packages/react-reconciler/src/ReactFiberHooks.js" target="_blank" rel="noopener noreferrer">ReactFiberHooks.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 包含着各种关于 Hooks 逻辑的处理，本章中的代码均来自该文件。</p><h3 id="hook-对象"><a aria-hidden="true" href="#hook-对象"><span class="icon icon-link"></span></a>Hook 对象</h3><p>在之前的章节有介绍过，Fiber 中的 <code>memorizedStated</code> 用来存储 <code>state</code>。</p><p>在类组件中 <code>state</code> 是一整个对象，可以和 <code>memoizedState</code> 一一对应。但是在 Hooks 中，React 并不知道我们调用了几次 <code>useState</code>，所以 React 通过将一个 Hook 对象挂载在 <code>memorizedStated</code> 上来保存函数组件的 <code>state</code>。</p><p>Hook 对象的结构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactFiberHooks.js
export type Hook = {
  memoizedState: any,

  baseState: any,
  baseUpdate: Update&lt;any, any&gt; | null,
  queue: UpdateQueue&lt;any, any&gt; | null,

  next: Hook | null,
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  memoizedState</span><span class="token punctuation">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  baseState</span><span class="token punctuation">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  baseUpdate</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  queue</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>重点关注 <code>memoizedState</code> 和 <code>next</code>。</p><p><code>memoizedState</code> 是用来记录当前 <code>useState</code> 应该返回的结果的。</p><ul><li><code>queue</code>：缓存队列，存储多次更新行为</li><li><code>next</code>：指向下一次 <code>useState</code> 对应的 Hook 对象。</li></ul><p>结合示例代码来看：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import React, { useState } from &#x27;react&#x27;
import &#x27;./App.css&#x27;

export default function App() {

  const [count, setCount] = useState(0);
  const [name, setName] = useState(&#x27;Star&#x27;);

  // 调用三次setCount便于查看更新队列的情况
  const countPlusThree = () =&gt; {
    setCount(count+1);
    setCount(count+2);
    setCount(count+3);
  }
  return (
    &lt;div className=&#x27;App&#x27;&gt;
      &lt;p&gt;{name} Has Clicked &lt;strong&gt;{count}&lt;/strong&gt; Times&lt;/p&gt;
      &lt;button onClick={countPlusThree}&gt;Click *3&lt;/button&gt;
    &lt;/div&gt;
  )
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">import</span><span class="token plain"> React</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> useState </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token string">&#x27;./App.css&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">count</span><span class="token punctuation">,</span><span class="token plain"> setCount</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"> setName</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#x27;Star&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 调用三次setCount便于查看更新队列的情况</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">countPlusThree</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">className</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">App</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">name</span><span class="token punctuation">}</span><span class="token plain"> Has Clicked </span><span class="token tag punctuation">&lt;</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token plain"> Times</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">countPlusThree</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain">Click </span><span class="token operator">*</span><span class="token number">3</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>第一次点击按钮触发更新时，<code>memoizedState</code> 的结构如下</p></div><img alt="第一次触发更新的memoizedState" src="/react-guidebook/static/memoized-state-1.f6461545.png" width="520"/><div class="markdown"><p>只是符合之前对 Hook 对象结构的分析，只是 <code>queue</code> 中的结构貌似有点奇怪，我们将在第三章第 2 节中进行分析。</p><h3 id="renderwithhooks"><a aria-hidden="true" href="#renderwithhooks"><span class="icon icon-link"></span></a>renderWithHooks</h3><p><code>renderWithHooks</code> 的运行过程如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactFiberHooks.js
export function renderWithHooks(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: any,
  props: any,
  refOrContext: any,
  nextRenderExpirationTime: ExpirationTime,
): any {
  renderExpirationTime = nextRenderExpirationTime;
  currentlyRenderingFiber = workInProgress;

  // 如果 current 的值为空，说明还没有 hook 对象被挂载
  // 而根据 hook 对象结构可知，current.memoizedState 指向下一个 current
  nextCurrentHook = current !== null ? current.memoizedState : null;

  // 用 nextCurrentHook 的值来区分 mount 和 update，设置不同的 dispatcher
  ReactCurrentDispatcher.current =
      nextCurrentHook === null
      // 初始化时
        ? HooksDispatcherOnMount
        // 更新时
        : HooksDispatcherOnUpdate;

  // 此时已经有了新的 dispatcher,在调用 Component 时就可以拿到新的对象
  let children = Component(props, refOrContext);

  // 重置
  ReactCurrentDispatcher.current = ContextOnlyDispatcher;

  const renderedWork: Fiber = (currentlyRenderingFiber: any);

  // 更新 memoizedState 和 updateQueue
  renderedWork.memoizedState = firstWorkInProgressHook;
  renderedWork.updateQueue = (componentUpdateQueue: any);

   /** 省略与本文无关的部分代码，便于理解 **/
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">current</span><span class="token parameter punctuation">:</span><span class="token parameter"> Fiber </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter punctuation">:</span><span class="token parameter"> Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  Component</span><span class="token parameter punctuation">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  props</span><span class="token parameter punctuation">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  refOrContext</span><span class="token parameter punctuation">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  nextRenderExpirationTime</span><span class="token parameter punctuation">:</span><span class="token parameter"> ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"> any </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderExpirationTime </span><span class="token operator">=</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  currentlyRenderingFiber </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果 current 的值为空，说明还没有 hook 对象被挂载</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 而根据 hook 对象结构可知，current.memoizedState 指向下一个 current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextCurrentHook </span><span class="token operator">=</span><span class="token plain"> current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用 nextCurrentHook 的值来区分 mount 和 update，设置不同的 dispatcher</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextCurrentHook </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 初始化时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnMount</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 更新时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnUpdate</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 此时已经有了新的 dispatcher,在调用 Component 时就可以拿到新的对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> children </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Component</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">,</span><span class="token plain"> refOrContext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 重置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ContextOnlyDispatcher</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> renderedWork</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">currentlyRenderingFiber</span><span class="token punctuation">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 更新 memoizedState 和 updateQueue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderedWork</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> firstWorkInProgressHook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderedWork</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">componentUpdateQueue</span><span class="token punctuation">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token doc-comment comment"> /** 省略与本文无关的部分代码，便于理解 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="初始化时"><a aria-hidden="true" href="#初始化时"><span class="icon icon-link"></span></a>初始化时</h4><p><strong>核心：</strong> 创建一个新的 hook，初始化 <code>state</code>， 并绑定触发器。</p><p>初始化阶段 <code>ReactCurrentDispatcher.current</code> 会指向 <code>HooksDispatcherOnMount</code> 对象</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactFiberHooks.js

const HooksDispatcherOnMount: Dispatcher = {
/** 省略其它Hooks **/
  useState: mountState,
};

// 所以调用 useState(0) 返回的就是 HooksDispatcherOnMount.useState(0)，也就是 mountState(0)
function mountState&lt;S&gt;(
  initialState: (() =&gt; S) | S,
): [S, Dispatch&lt;BasicStateAction&lt;S&gt;&gt;] {
  // 访问 Hook 链表的下一个节点，获取到新的 Hook 对象
  const hook = mountWorkInProgressHook();

  // 如果入参是 function 则会调用，但是不提供参数
  if (typeof initialState === &#x27;function&#x27;) {
    initialState = initialState();
  }

  // 进行 state 的初始化工作
  hook.memoizedState = hook.baseState = initialState;

  // 进行 queue 的初始化工作
  const queue = (hook.queue = {
    last: null,
    dispatch: null,
    eagerReducer: basicStateReducer, // useState 使用基础 reducer
    eagerState: (initialState: any),
  });

    // 返回触发器
  const dispatch: Dispatch&lt;BasicStateAction&lt;S&gt;,&gt;
    = (queue.dispatch = (dispatchAction.bind(
      null,
      // 绑定当前 fiber 节点和 queue
      ((currentlyRenderingFiber: any): Fiber),
      queue,
  ));

  // 返回初始 state 和触发器
  return [hook.memoizedState, dispatch];
}

// 对于 useState 触发的 update action 来说（假设 useState 里面都传的变量），basicStateReducer 就是直接返回 action 的值
function basicStateReducer&lt;S&gt;(state: S, action: BasicStateAction&lt;S&gt;): S {
  return typeof action === &#x27;function&#x27; ? action(state) : action;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnMount</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token doc-comment comment"></span></div><div class="token-line"><span class="token doc-comment comment">/** 省略其它Hooks **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useState</span><span class="token punctuation">:</span><span class="token plain"> mountState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 所以调用 useState(0) 返回的就是 HooksDispatcherOnMount.useState(0)，也就是 mountState(0)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> mountState</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  initialState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatch</span><span class="token operator">&lt;</span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 访问 Hook 链表的下一个节点，获取到新的 Hook 对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果入参是 function 则会调用，但是不提供参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> initialState </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    initialState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 进行 state 的初始化工作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">baseState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> initialState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 进行 queue 的初始化工作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> queue </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    last</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    dispatch</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    eagerReducer</span><span class="token punctuation">:</span><span class="token plain"> basicStateReducer</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// useState 使用基础 reducer</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    eagerState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token punctuation">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 返回触发器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dispatch</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatch</span><span class="token operator">&lt;</span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">dispatchAction</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 绑定当前 fiber 节点和 queue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">currentlyRenderingFiber</span><span class="token punctuation">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      queue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 返回初始 state 和触发器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 对于 useState 触发的 update action 来说（假设 useState 里面都传的变量），basicStateReducer 就是直接返回 action 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> basicStateReducer</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> action </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>重点讲一下返回的这个更新函数 <code>dispatchAction</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function dispatchAction&lt;S, A&gt;(
  fiber: Fiber,
  queue: UpdateQueue&lt;S, A&gt;,
  action: A,
) {

   /** 省略 Fiber 调度相关代码 **/

  // 创建新的新的 update, action 就是我们 setCount 里面的值 (count+1, count+2, count+3…)
    const update: Update&lt;S, A&gt; = {
      expirationTime,
      action,
      eagerReducer: null,
      eagerState: null,
      next: null,
    };

    // 重点：构建 queue
    // queue.last 是最近的一次更新，然后 last.next 开始是每一次的 action
    const last = queue.last;
    if (last === null) {
      // 只有一个 update, 自己指自己-形成环
      update.next = update;
    } else {
      const first = last.next;
      if (first !== null) {

        update.next = first;
      }
      last.next = update;
    }
    queue.last = update;

    /** 省略特殊情况相关代码 **/

    // 创建一个更新任务
    scheduleWork(fiber, expirationTime);
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> dispatchAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  fiber</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  queue</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  action</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token doc-comment comment"> /** 省略 Fiber 调度相关代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 创建新的新的 update, action 就是我们 setCount 里面的值 (count+1, count+2, count+3…)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> update</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      action</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      eagerReducer</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      eagerState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 重点：构建 queue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// queue.last 是最近的一次更新，然后 last.next 开始是每一次的 action</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> last </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">last</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">last </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 只有一个 update, 自己指自己-形成环</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> first </span><span class="token operator">=</span><span class="token plain"> last</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">first </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> first</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      last</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    queue</span><span class="token punctuation">.</span><span class="token property-access">last</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token doc-comment comment"> /** 省略特殊情况相关代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 创建一个更新任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在 <code>dispatchAction</code> 中维护了一份 <code>queue</code> 的数据结构。</p><p><code>queue</code> 是一个有环链表，规则：</p><ul><li><code>queue.last</code> 指向最近一次更新</li><li><code>last.next</code> 指向第一次更新</li><li>后面就依次类推，最终倒数第二次更新指向 <code>last</code>，形成一个环。</li></ul><p>所以每次插入新 <code>update</code> 时，就需要将原来的 <code>first</code> 指向 <code>queue.last.next</code>。再将 <code>update</code> 指向 <code>queue.next</code>，最后将 <code>queue.last</code> 指向 <code>update</code>。</p><p>下面结合示例代码来画图说明一下：</p><p>前面给出了第一次点击按钮更新时，<code>memorizedState</code> 中的 <code>queue</code> 值。</p></div><img alt="第一次触发更新的queue值" src="/react-guidebook/static/memorized-state-queue.2bd4552c.png" width="520"/><div class="markdown"><p>其构建过程如下图所示：</p></div><img alt="memorizedState构建过程" src="/react-guidebook/static/memorized-state-build.0ae0f6e7.png" width="520"/><div class="markdown"><p>即保证 <code>queue.last</code> 始终为最新的 <code>action</code>, 而 <code>queue.last.next</code> 始终为 <code>action: 1</code></p><h4 id="更新时"><a aria-hidden="true" href="#更新时"><span class="icon icon-link"></span></a>更新时</h4><p><strong>核心：</strong>获取该 Hook 对象中的 <code>queue</code>，内部存有本次更新的一系列数据，进行更新</p><p>更新阶段 <code>ReactCurrentDispatcher.current</code> 会指向 <code>HooksDispatcherOnUpdate</code> 对象</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ReactFiberHooks.js

// 所以调用 useState(0) 返回的就是 HooksDispatcherOnUpdate.useState(0)，也就是 updateReducer(basicStateReducer, 0)

const HooksDispatcherOnUpdate: Dispatcher = {
  /** 省略其它Hooks **/
   useState: updateState,
}

function updateState(initialState) {
  return updateReducer(basicStateReducer, initialState);
}

// 可以看到 updateReducer 的过程与传的 initalState 已经无关了，所以初始值只在第一次被使用

// 为了方便阅读，删去了一些无关代码
// 查看完整代码：https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberHooks.js#L606
function updateReducer(reducer, initialArg, init) {
// 获取初始化时的 hook
  const hook = updateWorkInProgressHook();
  const queue = hook.queue;

  // 开始渲染更新
  if (numberOfReRenders &gt; 0) {
    const dispatch = queue.dispatch;
    if (renderPhaseUpdates !== null) {
      // 获取 Hook 对象上的 queue，内部存有本次更新的一系列数据
      const firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);
      if (firstRenderPhaseUpdate !== undefined) {
        renderPhaseUpdates.delete(queue);
        let newState = hook.memoizedState;
        let update = firstRenderPhaseUpdate;
        // 获取更新后的 state
        do {
          const action = update.action;
          // 此时的 reducer 是 basicStateReducer，直接返回 action 的值
          newState = reducer(newState, action);
          update = update.next;
        } while (update !== null);
        // 对 更新 hook.memoized
        hook.memoizedState = newState;
        // 返回新的 state，及更新 hook 的 dispatch 方法
        return [newState, dispatch];
      }
    }
  }

// 对于 useState 触发的 update action 来说（假设 useState 里面都传的变量），basicStateReducer 就是直接返回 action 的值
function basicStateReducer&lt;S&gt;(state: S, action: BasicStateAction&lt;S&gt;): S {
  return typeof action === &#x27;function&#x27; ? action(state) : action;
" data-status="copy"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 所以调用 useState(0) 返回的就是 HooksDispatcherOnUpdate.useState(0)，也就是 updateReducer(basicStateReducer, 0)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnUpdate</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token doc-comment comment"> /** 省略其它Hooks **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   useState</span><span class="token punctuation">:</span><span class="token plain"> updateState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token plain">basicStateReducer</span><span class="token punctuation">,</span><span class="token plain"> initialState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 可以看到 updateReducer 的过程与传的 initalState 已经无关了，所以初始值只在第一次被使用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 为了方便阅读，删去了一些无关代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 查看完整代码：https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberHooks.js#L606</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token parameter punctuation">,</span><span class="token parameter"> initialArg</span><span class="token parameter punctuation">,</span><span class="token parameter"> init</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取初始化时的 hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> queue </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 开始渲染更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">numberOfReRenders </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> dispatch </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">renderPhaseUpdates </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 获取 Hook 对象上的 queue，内部存有本次更新的一系列数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> firstRenderPhaseUpdate </span><span class="token operator">=</span><span class="token plain"> renderPhaseUpdates</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">firstRenderPhaseUpdate </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderPhaseUpdates</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> newState </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> firstRenderPhaseUpdate</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 获取更新后的 state</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 此时的 reducer 是 basicStateReducer，直接返回 action 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          newState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">reducer</span><span class="token punctuation">(</span><span class="token plain">newState</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          update </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">update </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 对 更新 hook.memoized</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 返回新的 state，及更新 hook 的 dispatch 方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">newState</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 对于 useState 触发的 update action 来说（假设 useState 里面都传的变量），basicStateReducer 就是直接返回 action 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> basicStateReducer</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> action </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="总结"><a aria-hidden="true" href="#总结"><span class="icon icon-link"></span></a>总结</h4><p>单个 Hooks 的更新行为全都挂在 <code>Hooks.queue</code> 下，所以能够管理好 <code>queue</code> 的核心就在于</p><ul><li>初始化 queue - <code>mountState</code></li><li>维护 queue - <code>dispatchAction</code></li><li>更新 queue - <code>updateReducer</code></li></ul><p>结合示例代码：</p><ul><li>当我们第一次调用 <code>[count, setCount] = useState(0)</code> 时，创建一个 <code>queue</code></li><li>每一次调用 <code>setCount(x)</code>，就 <code>dispach</code> 一个内容为 <code>x</code> 的 <code>action</code>（<code>action</code>  的表现为：将 <code>count</code> 设为 <code>x</code>），<code>action</code> 存储在 <code>queue</code> 中，以前面讲述的有环链表规则来维护</li><li>这些 <code>action</code>  最终在 <code>updateReducer</code> 中被调用，更新到 <code>memorizedState</code> 上，使我们能够获取到最新的 <code>state</code> 值</li></ul><h2 id="总结-1"><a aria-hidden="true" href="#总结-1"><span class="icon icon-link"></span></a>总结</h2><h3 id="使用原则"><a aria-hidden="true" href="#使用原则"><span class="icon icon-link"></span></a>使用原则</h3><p>官方文档对于使用 hooks 有以下两点要求：</p><ul><li>只在 React 函数中使用 Hooks</li><li>只在自定义 Hooks 中使用 Hooks</li></ul><h3 id="为什么不能在循环条件语句中执行"><a aria-hidden="true" href="#为什么不能在循环条件语句中执行"><span class="icon icon-link"></span></a>为什么不能在循环/条件语句中执行</h3><p>以 <code>useState</code> 为例：</p><p>和类组件存储state不同，React并不知道我们调用了几次 <code>useState</code>，对 <code>hooks</code> 的存储是按顺序的（参见 Hook 结构），一个 <code>hook</code> 对象的 <code>next</code> 指向下一个 <code>hooks</code>。所以当我们建立示例代码中的对应关系后，<code>Hook</code> 的结构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// hook1: const [count, setCount] = useState(0) — 拿到state1
{
  memorizedState: 0
  next : {
    // hook2: const [name, setName] = useState(&#x27;Star&#x27;) - 拿到state2
    memorizedState: &#x27;Star&#x27;
    next : {
      null
    }
  }
}

// hook1 =&gt; Fiber.memoizedState
// state1 === hook1.memoizedState
// hook1.next =&gt; hook2
// state2 === hook2.memoizedState
" data-status="copy"></button><div class="token-line"><span class="token comment">// hook1: const [count, setCount] = useState(0) — 拿到state1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  memorizedState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  next </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// hook2: const [name, setName] = useState(&#x27;Star&#x27;) - 拿到state2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memorizedState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;Star&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// hook1 =&gt; Fiber.memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// state1 === hook1.memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// hook1.next =&gt; hook2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// state2 === hook2.memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>所以如果把 <code>hook1</code> 放到一个 <code>if</code> 语句中，当这个没有执行时，<code>hook2</code> 拿到的 <code>state</code> 其实是上一次 <code>hook1</code> 执行后的 <code>state</code>（而不是上一次 <code>hook2</code> 执行后的）。这样显然会发生错误。</p><blockquote><p>关于这块内容如果想了解更多可以看一下 <a href="https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba" target="_blank" rel="noopener noreferrer">这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><h3 id="为什么只能在函数组件中使用-hooks"><a aria-hidden="true" href="#为什么只能在函数组件中使用-hooks"><span class="icon icon-link"></span></a>为什么只能在函数组件中使用 hooks</h3><p>只有函数组件的更新才会触发 <code>renderWithHooks</code> 函数，处理 Hooks 相关逻辑。</p><p>还是以 <code>setState</code> 为例，类组件和函数组件重新渲染的逻辑不同 ：</p><ul><li><strong>类组件：</strong> 用 <code>setState</code> 触发 <code>updater</code>，重新执行组件中的 <code>render</code> 方法</li><li><strong>函数组件：</strong> 用 <code>useState</code> 返回的 <code>setter</code> 函数来 <code>dispatch</code> 一个 <code>update action</code>，触发更新（<code>dispatchAction</code> 最后的 <code>scheduleWork</code>），用 <code>updateReducer</code> 处理更新逻辑，返回最新的 <code>state</code> 值（与 Redux 比较像）</li></ul><h3 id="usestate-整体运作流程总结"><a aria-hidden="true" href="#usestate-整体运作流程总结"><span class="icon icon-link"></span></a>useState 整体运作流程总结</h3><p>说了这么多，最后再简要总结下 <code>useState</code> 的执行流程。</p><ul><li><strong>初始化：</strong> 构建 <code>dispatcher</code> 函数和初始值。</li><li><strong>更新时：</strong><ol><li>调用 <code>dispatcher</code> 函数，按序插入 <code>update</code>（其实就是一个 <code>action</code>）</li><li>收集 <code>update</code>，调度一次 React 的更新</li><li>在更新的过程中将 <code>ReactCurrentDispatcher.current</code> 指向负责更新的 <code>Dispatcher</code></li><li>执行到函数组件 <code>App()</code> 时，<code>useState</code> 会被重新执行，在 <code>resolve dispatcher</code> 的阶段拿到了负责更新的 <code>dispatcher</code>。</li><li><code>useState</code> 会拿到 Hook 对象，<code>Hook.queue</code> 中存储了更新队列，依次进行更新后，即可拿到最新的 <code>state</code></li><li>函数组件 <code>App()</code> 执行后返回的 <code>nextChild</code> 中的 <code>count</code> 值已经是最新的了。<code>FiberNode</code> 中的 <code>memorizedState</code> 也被设置为最新的 <code>state</code></li><li>Fiber 渲染出真实 DOM，更新结束。</li></ol></li></ul><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://juejin.im/post/6844903833764642830" target="_blank" rel="noopener noreferrer">📝 从源码剖析 useState 的执行过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/6844903990958784526" target="_blank" rel="noopener noreferrer">📝 React Hooks 源码解析：useState<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/React-GuideBook/edit/master/docs/hooks/hooks/hooks-analysis.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">8/31/2020, 7:09:52 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/react-guidebook/umi.js"></script>
    <script src="/react-guidebook/docs__hooks__hooks__hooks-analysis.md.js"></script>
  </body>
</html>
