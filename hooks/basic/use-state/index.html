<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/react-guidebook/umi.css" />
    <script>
      window.routerBase = "/react-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>useState</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/react-guidebook//">React Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/react-guidebook//foundation">基础</a><a href="/react-guidebook//architect">架构</a><a href="/react-guidebook//ecosystem">生态</a><a href="/react-guidebook//api-reference">API</a><a aria-current="page" class="active" href="/react-guidebook//hooks">Hooks</a><a href="/react-guidebook//extensions">Extensions</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/react-guidebook//"></a><h1>React Guidebook</h1><p>React 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/react-guidebook//foundation">基础</a></li><li><a href="/react-guidebook//architect">架构</a></li><li><a href="/react-guidebook//ecosystem">生态</a></li><li><a href="/react-guidebook//api-reference">API</a></li><li><a aria-current="page" class="active" href="/react-guidebook//hooks">Hooks</a></li><li><a href="/react-guidebook//extensions">Extensions</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/react-guidebook//hooks">Hooks</a><ul><li><a href="/react-guidebook//hooks"><span>Hooks</span></a></li><li><a href="/react-guidebook//hooks/hooks-analysis"><span>useState 源码分析</span></a></li><li><a href="/react-guidebook//hooks/hooks-faq"><span>FAQ</span></a></li></ul></li><li><a aria-current="page" class="active" href="/react-guidebook//hooks/basic">基础 Hook</a><ul><li><a aria-current="page" class="active" href="/react-guidebook//hooks/basic/use-state"><span>useState</span></a></li><li><a href="/react-guidebook//hooks/basic/use-effect"><span>useEffect</span></a></li><li><a href="/react-guidebook//hooks/basic/use-context"><span>useContext</span></a></li></ul></li><li><a href="/react-guidebook//hooks/extra">额外的 Hook</a><ul><li><a href="/react-guidebook//hooks/extra/use-reducer"><span>useReducer</span></a></li><li><a href="/react-guidebook//hooks/extra/use-callback"><span>useCallback</span></a></li><li><a href="/react-guidebook//hooks/extra/use-memo"><span>useMemo</span></a></li><li><a href="/react-guidebook//hooks/extra/use-ref"><span>useRef</span></a></li><li><a href="/react-guidebook//hooks/extra/use-imperative-handle"><span>useImperativeHandle</span></a></li><li><a href="/react-guidebook//hooks/extra/use-layout-effect"><span>useLayoutEffect</span></a></li><li><a href="/react-guidebook//hooks/extra/use-debug-value"><span>useDebugValue</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="基本用法" data-depth="2" class=""><a href="/react-guidebook//hooks/basic/use-state#基本用法"><span>基本用法</span></a></li><li title="函数式更新" data-depth="3" class=""><a href="/react-guidebook//hooks/basic/use-state#函数式更新"><span>函数式更新</span></a></li><li title="惰性初始值" data-depth="3" class=""><a href="/react-guidebook//hooks/basic/use-state#惰性初始值"><span>惰性初始值</span></a></li><li title="跳过更新" data-depth="3" class=""><a href="/react-guidebook//hooks/basic/use-state#跳过更新"><span>跳过更新</span></a></li><li title="原理简述" data-depth="2" class=""><a href="/react-guidebook//hooks/basic/use-state#原理简述"><span>原理简述</span></a></li><li title="基础概念" data-depth="3" class=""><a href="/react-guidebook//hooks/basic/use-state#基础概念"><span>基础概念</span></a></li><li title="实现原理" data-depth="3" class=""><a href="/react-guidebook//hooks/basic/use-state#实现原理"><span>实现原理</span></a></li><li title="状态更新" data-depth="3" class=""><a href="/react-guidebook//hooks/basic/use-state#状态更新"><span>状态更新</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="usestate"><a aria-hidden="true" href="#usestate"><span class="icon icon-link"></span></a>useState</h1><p><a href="https://zh-hans.reactjs.org/docs/hooks-state.html" target="_blank" rel="noopener noreferrer">官方文档：使用 State Hook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="基本用法"><a aria-hidden="true" href="#基本用法"><span class="icon icon-link"></span></a>基本用法</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const [ state, setState ] = useState(initialState);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> state</span><span class="token punctuation">,</span><span class="token plain"> setState </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>返回一个 <code>state</code>，以及更新 <code>state</code> 的函数。</p><p>在 <strong>初始渲染</strong> 期间，返回的状态（<code>state</code>）与传入的第一个参数（<code>initialState</code>）值相同。</p><p><code>setState</code> 函数用于更新 <code>state</code>。它接收一个新的 <code>state</code> 值并将组件的一次重新渲染加入队列。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="setState(newState);
" data-status="copy"></button><div class="token-line"><span class="token function">setState</span><span class="token punctuation">(</span><span class="token plain">newState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在后续的重新渲染中，<code>useState</code> 返回的第一个值将始终是更新后最新的 <code>state</code>。</p><p>⚠️ <strong>注意：</strong></p><ol><li>React 会确保 <code>setState</code> 函数的标识是稳定的，并且不会在组件重新渲染时发生变化。这就是为什么可以安全地从 <code>useEffect</code> 或 <code>useCallback</code> 的依赖列表中省略 <code>setState</code>。</li><li>Hook 在 class 内部是不起作用的。但你可以使用它们来取代 class 。</li></ol><h3 id="函数式更新"><a aria-hidden="true" href="#函数式更新"><span class="icon icon-link"></span></a>函数式更新</h3><p>如果新的 <code>state</code> 需要通过使用先前的 <code>state</code> 计算得出，那么可以将函数传递给 <code>setState</code>。该函数将接收先前的 <code>state</code>，并返回一个更新后的值。下面的计数器组件示例展示了 <code>setState</code> 的两种用法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function Counter({initialCount}) {
  const [count, setCount] = useState(initialCount);
  return (
    &lt;&gt;
      Count: {count}
      &lt;button onClick={() =&gt; setCount(initialCount)}&gt;Reset&lt;/button&gt;
      &lt;button onClick={() =&gt; setCount(prevCount =&gt; prevCount - 1)}&gt;-&lt;/button&gt;
      &lt;button onClick={() =&gt; setCount(prevCount =&gt; prevCount + 1)}&gt;+&lt;/button&gt;
    &lt;/&gt;
  );
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">Counter</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter">initialCount</span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">count</span><span class="token punctuation">,</span><span class="token plain"> setCount</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token plain">initialCount</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      Count</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript function">setCount</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript">initialCount</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain">Reset</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript function">setCount</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript parameter">prevCount</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> prevCount </span><span class="token tag script language-javascript operator">-</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript number">1</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token operator">-</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript function">setCount</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript parameter">prevCount</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> prevCount </span><span class="token tag script language-javascript operator">+</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript number">1</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token operator">+</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>+</code> 和 <code>-</code> 按钮采用函数式形式，因为被更新的 <code>state</code> 需要基于之前的 <code>state</code>。但是“重置”按钮则采用普通形式，因为它总是把 <code>count</code> 设置回初始值。</p><p>如果你的更新函数返回值与当前 state 完全相同，则随后的重渲染会被完全跳过。</p><p>⚠️ <strong>注意：</strong></p><p>与 <code>class</code> 组件中的 <code>setState</code> 方法不同，<code>useState</code> 不会自动合并更新对象。你可以用函数式的 <code>setState</code> 结合展开运算符来达到合并更新对象的效果。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="setState(prevState =&gt; {
  // 也可以使用 Object.assign
  return {
    ...prevState,
    ...updateValues
  }
});
" data-status="copy"></button><div class="token-line"><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 也可以使用 Object.assign</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token spread operator">...</span><span class="token plain">prevState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token spread operator">...</span><span class="token plain">updateValues</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>useReducer</code> 是另一种可选方案，它更适合用于管理包含多个子值的 <code>state</code> 对象。</p><h3 id="惰性初始值"><a aria-hidden="true" href="#惰性初始值"><span class="icon icon-link"></span></a>惰性初始值</h3><p><code>initialState</code> 参数只会在组件的初始渲染中起作用，后续渲染时会被忽略。如果初始 <code>state</code> 需要通过复杂计算获得，则可以传入一个函数，在函数中计算并返回初始的 <code>state</code>，此函数只在初始渲染时被调用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const [state, setState] = useState(() =&gt; {
  const initialState = someExpensiveComputation(props);
  return initialState
})
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state</span><span class="token punctuation">,</span><span class="token plain"> setState</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> initialState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">someExpensiveComputation</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> initialState</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="跳过更新"><a aria-hidden="true" href="#跳过更新"><span class="icon icon-link"></span></a>跳过更新</h3><p>调用 State Hook 的更新函数并传入当前的 <code>state</code> 时，React 将跳过子组件的渲染及 <code>effect</code> 的执行。（React 使用 <code>Object.is</code> 比较算法 来比较 <code>state</code>）</p><p>需要注意的是，React 可能仍需要在跳过渲染前渲染该组件。不过由于 React 不会对组件树的 <strong>深层节点</strong> 进行不必要的渲染，所以大可不必担心。如果你在渲染期间执行了高开销的计算，则可以使用 <code>useMemo</code> 来进行优化。</p><h2 id="原理简述"><a aria-hidden="true" href="#原理简述"><span class="icon icon-link"></span></a>原理简述</h2><p>首先 <code>useState</code> 是一个方法，它本身是无法存储状态的。</p><p>其次，他运行在 Stateless Component 里面，本身也是无法保存状态的。</p><p><code>useState</code> 只接收一个参数 <code>initial value</code>，并看不出有什么特殊的地方。所以 React 在一次重新渲染的时候如何获取之前更新过的 <code>state</code> 呢？</p><p>在开始讲解源码之前，大家先要建立一些概念。</p><h3 id="基础概念"><a aria-hidden="true" href="#基础概念"><span class="icon icon-link"></span></a>基础概念</h3><p><strong>React Element</strong></p><p>JSX 编译解析后就是 <code>React.createElement</code>，最终返回的是一个 <code>ReactElement</code> 对象，他的数据解构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const element = {
  ?typeof: REACT_ELEMENT_TYPE, // 是否是普通Element_Type

  // Built-in properties that belong on the element
  // 我们的组件，比如 `class MyComponent`
  type: type,
  key: key,
  ref: ref,
  props: props,

  // Record the component responsible for creating this element.
  _owner: owner,
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">?</span><span class="token keyword">typeof</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 是否是普通Element_Type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Built-in properties that belong on the element</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 我们的组件，比如 `class MyComponent`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  type</span><span class="token punctuation">:</span><span class="token plain"> type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  key</span><span class="token punctuation">:</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ref</span><span class="token punctuation">:</span><span class="token plain"> ref</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  props</span><span class="token punctuation">:</span><span class="token plain"> props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Record the component responsible for creating this element.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _owner</span><span class="token punctuation">:</span><span class="token plain"> owner</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这其中需要注意的是 <code>type</code>，在我们写 <code>&lt;MyClassComponent <!-- -->{<!-- -->...props<!-- -->}<!-- --> /&gt;</code> 的时候，他的值就是 <code>MyClassComponent</code> 这个 <code>class</code>，而不是他的实例，实例是在后续渲染的过程中创建的。</p><p><strong>Fiber</strong></p><p>每个节点都会有一个对应的 Fiber 对象，他的数据解构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function FiberNode(
  tag: WorkTag,
  pendingProps: mixed,
  key: null | string,
  mode: TypeOfMode,
) {
  // Instance
  this.tag = tag;
  this.key = key;
  // 就是 ReactElement 的 `?typeof`
  this.elementType = null;
  // 就是 ReactElement 的 type
  this.type = null;
  this.stateNode = null;

  // Fiber
  this.return = null;
  this.child = null;
  this.sibling = null;
  this.index = 0;2

  this.ref = null;

  this.pendingProps = pendingProps;
  this.memoizedProps = null;
  this.updateQueue = null;
  // 上次渲染过程中最终获得的节点的状态 State
  // 每次 render 之前会计算出最新的状态，然后赋值给组件实例，再调用 render
  this.memoizedState = null;
  this.firstContextDependency = null;

  // ...others
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">FiberNode</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">tag</span><span class="token parameter punctuation">:</span><span class="token parameter"> WorkTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  pendingProps</span><span class="token parameter punctuation">:</span><span class="token parameter"> mixed</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  key</span><span class="token parameter punctuation">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  mode</span><span class="token parameter punctuation">:</span><span class="token parameter"> TypeOfMode</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Instance</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> tag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 就是 ReactElement 的 `?typeof`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 就是 ReactElement 的 type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Fiber</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">return</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">index</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 上次渲染过程中最终获得的节点的状态 State</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 每次 render 之前会计算出最新的状态，然后赋值给组件实例，再调用 render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">firstContextDependency</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...others</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在这里我们需要注意的是 <code>this.memoizedState</code>，这个 <code>key</code> 就是用来存储在上次渲染过程中最终获得的节点的 <code>state</code> 的，每次执行 <code>render</code> 方法之前，React 会计算出当前组件最新的 <code>state</code> 然后赋值给 <code>class</code> 的实例，再调用 <code>render</code>。</p><p>所以很多不是很清楚 React 原理的同学会对 React 的 Class Component 有误解，认为 <code>state</code> 和 <code>lifeCycle</code> 都是自己主动调用的，因为我们继承了 React.Component，它里面肯定有很多相关逻辑。事实上如果有兴趣可以去看一下 Component 的源码，大概也就是 100 多行，非常简单。所以在 React 中，class 仅仅是一个载体，让我们写组件的时候更容易理解一点，毕竟组件和 class 都是封闭性较强的</p><h3 id="实现原理"><a aria-hidden="true" href="#实现原理"><span class="icon icon-link"></span></a>实现原理</h3><p>在知道上面的基础之后，对于 Hooks 为什么能够保存无状态组件的原理就比较好理解了。</p><p>我们假设有这么一段代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function FunctionalComponent () {
  const [state1, setState1] = useState(1)
  const [state2, setState2] = useState(2)
  const [state3, setState3] = useState(3)
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">FunctionalComponent</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state1</span><span class="token punctuation">,</span><span class="token plain"> setState1</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state2</span><span class="token punctuation">,</span><span class="token plain"> setState2</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state3</span><span class="token punctuation">,</span><span class="token plain"> setState3</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></div><img alt="函数组件与Fiber节点" src="/react-guidebook/static/functional-component-and-fiber.ec4ad85f.png" width="540"/><div class="markdown"><p>在我们执行函数组件的时候，在第一次执行到 <code>useState</code> 的时候，对应的是 Fiber 对象上的 <code>memoizedState</code>，这个属性原来设计来是用来存储 Class Component 的 <code>state</code> 的，因为在 ClassComponent 中 <code>state</code> 是一整个对象，所以可以和 <code>memoizedState</code> 一一对应。</p><p>但是在 Hooks 中，React 并不知道我们调用了几次 <code>useState</code>，所以在保存 <code>state</code> 这件事情上，React 想出了一个比较有意思的方案，那就是调用 <code>useState</code> 后设置在 <code>memoizedState</code> 上的对象长这样：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="{
  baseState,
  next,
  baseUpdate,
  queue,
  memoizedState
}
" data-status="copy"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  baseState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  next</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  baseUpdate</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  queue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  memoizedState</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>我们叫他 Hook 对象。这里面我们最需要关心的是 <code>memoizedState</code> 和 <code>next</code>，<code>memoizedState</code> 是用来记录这个 <code>useState</code> 应该返回的结果的，而 <code>next</code> 指向的是下一次 <code>useState</code> 对应的 Hook 对象。</p><p>也就是说：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 链表式结构
hook1 =&gt; Fiber.memoizedState
state1 === hook1.memoizedState
hook1.next =&gt; hook2
state2 === hook2.memoizedState
hook2.next =&gt; hook3
state3 === hook2.memoizedState

" data-status="copy"></button><div class="token-line"><span class="token comment">// 链表式结构</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token parameter">hook1</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">state1 </span><span class="token operator">===</span><span class="token plain"> hook1</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hook1</span><span class="token punctuation">.</span><span class="token parameter">next</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> hook2</span></div><div class="token-line"><span class="token plain">state2 </span><span class="token operator">===</span><span class="token plain"> hook2</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hook2</span><span class="token punctuation">.</span><span class="token parameter">next</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> hook3</span></div><div class="token-line"><span class="token plain">state3 </span><span class="token operator">===</span><span class="token plain"> hook2</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>每个在函数组件中调用的 <code>useState</code> 都会有一个对应的 Hook 对象，他们按照执行的顺序以类似链表的数据格式存放在 <code>Fiber.memoizedState</code> 上。</p><p>重点来了：就是因为是以这种方式进行 <code>state</code> 的存储，所以 <code>useState</code>（包括其他的 Hooks）都必须在 <strong>函数组件的根作用域</strong> 中声明，也就是不能在条件语句或者循环语句中声明，比如</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="if (something) {
  const [state1] = useState(1)
}

// 或者
for (something) {
  const [state2] = useState(2)
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">something</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state1</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 或者</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">something</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state2</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>最主要的原因就是你不能确保这些条件语句每次执行的次数是一样的，也就是说如果第一次我们创建了 <code>state1 =&gt; hook1</code>，<code>state2 =&gt; hook2</code>，<code>state3 =&gt; hook3</code> 这样的对应关系之后，下一次执行因为 <code>something</code> 条件没达成，导致 <code>useState(1)</code> 没有执行，那么运行 <code>useState(2)</code> 的时候，拿到的 Hooks 对象是 <code>state1</code> 的，那么整个逻辑就乱套了，所以这个原则是必须遵守的。</p><h3 id="状态更新"><a aria-hidden="true" href="#状态更新"><span class="icon icon-link"></span></a>状态更新</h3><p>上面讲了 Hooks 中 <code>state</code> 是如何保存的，那么接下去来讲讲如何更新 <code>state</code>。</p><p>我们调用的调用 <code>useState</code> 返回的方法是这样的：</p><p><a href="https://github.com/facebook/react/blob/ddd1faa1972b614dfbfae205f2aa4a6c0b39a759/packages/react-dom/src/server/ReactPartialRendererHooks.js#L335" target="_blank" rel="noopener noreferrer">源码地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var dispatch = queue.dispatch = dispatchAction.bind(null, currentlyRenderingFiber$1, queue);

return [workInProgressHook.memoizedState, dispatch];
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> dispatch </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> dispatchAction</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> currentlyRenderingFiber$</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> queue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>调用这个方法会创建一个 <code>update</code>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var update = {
  expirationTime: _expirationTime,
  action: action,
  callback: callback !== undefined ? callback : null,
  next: null
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  expirationTime</span><span class="token punctuation">:</span><span class="token plain"> _expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  action</span><span class="token punctuation">:</span><span class="token plain"> action</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback</span><span class="token punctuation">:</span><span class="token plain"> callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> callback </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这里的 <code>action</code> 是我们调用 <code>setState1</code> 传入的值，而这个 <code>update</code> 会被加入到 <code>queue</code> 上，因为可能存在一次性调用多次 <code>setState1</code> 的清空（跟 React 的 <code>batchUpdate</code> 批量更新有关）。</p><p>在收集完这所有 <code>update</code> 之后，会调度一次 React 的更新，在更新的过程中，肯定会执行到我们的函数组件爱你，那么就会执行到对应的 <code>useState</code>，然后我们就拿到了 Hook 对象，他保存了 <code>queue</code> 对象表示有哪些更新存在，然后依次进行更新，拿到最新的 <code>state</code> 保存在 <code>memoizedState</code> 上，并且返回，最终达到了 <code>setState</code> 的效果。</p><p>其实本质上跟 Class Component 是差不多的，只不过因为 <code>useState</code> 拆分了单一对象 <code>state</code>，所以要用一个相对独特的方式进行数据保存，而且会存在一定的规则限制。</p><p>但是这些条件完全不能掩盖 Hooks 的光芒，他的意义是在是太大了，让 React 这个 函数式编程范式的框架终于摆脱了要用类来创建组件的尴尬场面。事实上类的存在意义确实不大，比如 PuerComponent 现在也有对应的 <code>React.memo</code> 来让函数组件也能达到相同的效果。</p><p>最后，因为真的要把源码摊开来讲，就会涉及到一些其他的源码内容，比如 <code>workInProgress =&gt; current</code> 的转换，<code>expirationTime</code> 涉及的调度等，反而会导致大家无法理解本篇文章的主体 Hooks，所以我在写完完整源码解析后又总结归纳了这篇文章来单独发布。希望能帮助各位童鞋更好得理解 Hooks，并能大胆用到实际开发中去。</p><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://juejin.im/post/6844904152712085512" target="_blank" rel="noopener noreferrer">📝 ReactHooks 源码解析之 useState 及为什么 useState 要按顺序执行<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/6844903704437456909" target="_blank" rel="noopener noreferrer">📝 阅读源码后，来讲讲 React Hooks 是怎么实现的<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/React-GuideBook/edit/master/docs/hooks/basic/useState.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">8/31/2020, 7:09:52 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/react-guidebook/umi.js"></script>
    <script src="/react-guidebook/docs__hooks__basic__useState.md.js"></script>
  </body>
</html>
