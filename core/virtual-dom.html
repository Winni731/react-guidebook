<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Virtual DOM | React-Guidebook</title>
    <meta name="description" content="">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/react-guidebook/assets/css/0.styles.e28a9572.css" as="style"><link rel="preload" href="/react-guidebook/assets/js/app.260c1e95.js" as="script"><link rel="preload" href="/react-guidebook/assets/js/2.faf5b053.js" as="script"><link rel="preload" href="/react-guidebook/assets/js/6.38cc656d.js" as="script"><link rel="prefetch" href="/react-guidebook/assets/js/10.12b8a1f6.js"><link rel="prefetch" href="/react-guidebook/assets/js/11.08027518.js"><link rel="prefetch" href="/react-guidebook/assets/js/12.96017118.js"><link rel="prefetch" href="/react-guidebook/assets/js/13.843c2301.js"><link rel="prefetch" href="/react-guidebook/assets/js/14.350d4ea6.js"><link rel="prefetch" href="/react-guidebook/assets/js/15.922c628d.js"><link rel="prefetch" href="/react-guidebook/assets/js/16.179de27c.js"><link rel="prefetch" href="/react-guidebook/assets/js/17.d6f21d06.js"><link rel="prefetch" href="/react-guidebook/assets/js/18.3b94c7d4.js"><link rel="prefetch" href="/react-guidebook/assets/js/19.9d272f30.js"><link rel="prefetch" href="/react-guidebook/assets/js/20.5719f794.js"><link rel="prefetch" href="/react-guidebook/assets/js/21.32a481df.js"><link rel="prefetch" href="/react-guidebook/assets/js/22.a8130aca.js"><link rel="prefetch" href="/react-guidebook/assets/js/23.04c27a3a.js"><link rel="prefetch" href="/react-guidebook/assets/js/24.bc3baace.js"><link rel="prefetch" href="/react-guidebook/assets/js/25.e2bf72b2.js"><link rel="prefetch" href="/react-guidebook/assets/js/26.e2f5f647.js"><link rel="prefetch" href="/react-guidebook/assets/js/27.12c8dd66.js"><link rel="prefetch" href="/react-guidebook/assets/js/28.786c50e6.js"><link rel="prefetch" href="/react-guidebook/assets/js/29.bdb196e1.js"><link rel="prefetch" href="/react-guidebook/assets/js/3.28696f6a.js"><link rel="prefetch" href="/react-guidebook/assets/js/30.cf0e07b4.js"><link rel="prefetch" href="/react-guidebook/assets/js/31.6dad3ae2.js"><link rel="prefetch" href="/react-guidebook/assets/js/32.bd3b8924.js"><link rel="prefetch" href="/react-guidebook/assets/js/33.c7028e61.js"><link rel="prefetch" href="/react-guidebook/assets/js/34.980dc58f.js"><link rel="prefetch" href="/react-guidebook/assets/js/35.b7595861.js"><link rel="prefetch" href="/react-guidebook/assets/js/36.5096dad5.js"><link rel="prefetch" href="/react-guidebook/assets/js/37.95547070.js"><link rel="prefetch" href="/react-guidebook/assets/js/38.158db71c.js"><link rel="prefetch" href="/react-guidebook/assets/js/39.533eee82.js"><link rel="prefetch" href="/react-guidebook/assets/js/4.63e5ba6d.js"><link rel="prefetch" href="/react-guidebook/assets/js/40.58cb3743.js"><link rel="prefetch" href="/react-guidebook/assets/js/41.d5b5333a.js"><link rel="prefetch" href="/react-guidebook/assets/js/42.8fd16888.js"><link rel="prefetch" href="/react-guidebook/assets/js/43.17e7ea62.js"><link rel="prefetch" href="/react-guidebook/assets/js/44.c75d55fd.js"><link rel="prefetch" href="/react-guidebook/assets/js/45.cfb8cfbd.js"><link rel="prefetch" href="/react-guidebook/assets/js/46.21fefad7.js"><link rel="prefetch" href="/react-guidebook/assets/js/47.65560a73.js"><link rel="prefetch" href="/react-guidebook/assets/js/48.b09b6aff.js"><link rel="prefetch" href="/react-guidebook/assets/js/49.17f999ca.js"><link rel="prefetch" href="/react-guidebook/assets/js/5.dd0f972b.js"><link rel="prefetch" href="/react-guidebook/assets/js/50.3c7b255a.js"><link rel="prefetch" href="/react-guidebook/assets/js/51.f1ffef2a.js"><link rel="prefetch" href="/react-guidebook/assets/js/52.8414d27e.js"><link rel="prefetch" href="/react-guidebook/assets/js/53.ee10be58.js"><link rel="prefetch" href="/react-guidebook/assets/js/54.790296ee.js"><link rel="prefetch" href="/react-guidebook/assets/js/55.b3491420.js"><link rel="prefetch" href="/react-guidebook/assets/js/56.ded674be.js"><link rel="prefetch" href="/react-guidebook/assets/js/57.f989e8b0.js"><link rel="prefetch" href="/react-guidebook/assets/js/58.2cc1c592.js"><link rel="prefetch" href="/react-guidebook/assets/js/7.86641c97.js"><link rel="prefetch" href="/react-guidebook/assets/js/8.8391da58.js"><link rel="prefetch" href="/react-guidebook/assets/js/9.a3a45a50.js">
    <link rel="stylesheet" href="/react-guidebook/assets/css/0.styles.e28a9572.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/react-guidebook/" class="home-link router-link-active"><img src="/react-guidebook/favicon.png" alt="React-Guidebook" class="logo"> <span class="site-name can-hide">React-Guidebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/tsejx/React-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/tsejx/React-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基本概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/concept/react.html" class="sidebar-link">React 特性</a></li><li><a href="/react-guidebook/concept/jsx.html" class="sidebar-link">JSX 语法</a></li><li><a href="/react-guidebook/concept/props.html" class="sidebar-link">Props</a></li><li><a href="/react-guidebook/concept/state.html" class="sidebar-link">State</a></li><li><a href="/react-guidebook/concept/lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/react-guidebook/concept/component.html" class="sidebar-link">组件化</a></li><li><a href="/react-guidebook/concept/react-dom.html" class="sidebar-link">ReactDOM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>核心架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/core/fiber.html" class="sidebar-link">Fiber</a></li><li><a href="/react-guidebook/core/virtual-dom.html" class="active sidebar-link">Virtual DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react-guidebook/core/virtual-dom.html#基本原理" class="sidebar-link">基本原理</a></li><li class="sidebar-sub-header"><a href="/react-guidebook/core/virtual-dom.html#算法实现" class="sidebar-link">算法实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react-guidebook/core/virtual-dom.html#模拟-dom-树" class="sidebar-link">模拟 DOM 树</a></li><li class="sidebar-sub-header"><a href="/react-guidebook/core/virtual-dom.html#判断差异" class="sidebar-link">判断差异</a></li><li class="sidebar-sub-header"><a href="/react-guidebook/core/virtual-dom.html#算法实现总结" class="sidebar-link">算法实现总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/react-guidebook/core/virtual-dom.html#特点" class="sidebar-link">特点</a></li></ul></li><li><a href="/react-guidebook/core/diffing-algorithm.html" class="sidebar-link">差异化算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>运行机制</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/mechanism/set-state.html" class="sidebar-link">setState</a></li><li><a href="/react-guidebook/mechanism/render.html" class="sidebar-link">渲染策略</a></li><li><a href="/react-guidebook/mechanism/refs.html" class="sidebar-link">Refs</a></li><li><a href="/react-guidebook/mechanism/portals.html" class="sidebar-link">Portals</a></li><li><a href="/react-guidebook/mechanism/context.html" class="sidebar-link">Context</a></li><li><a href="/react-guidebook/mechanism/render-props.html" class="sidebar-link">Render Props</a></li><li><a href="/react-guidebook/mechanism/high-order-component.html" class="sidebar-link">高阶组件</a></li><li><a href="/react-guidebook/mechanism/handling-events.html" class="sidebar-link">事件处理</a></li><li><a href="/react-guidebook/mechanism/synthetic-event.html" class="sidebar-link">合成事件</a></li><li><a href="/react-guidebook/mechanism/hooks.html" class="sidebar-link">Hooks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>功能扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/feature/memo.html" class="sidebar-link">React.memo</a></li><li><a href="/react-guidebook/feature/pure-component.html" class="sidebar-link">React.PureComponent</a></li><li><a href="/react-guidebook/feature/fragment.html" class="sidebar-link">React.Fragment</a></li><li><a href="/react-guidebook/feature/create-ref.html" class="sidebar-link">React.createRef</a></li><li><a href="/react-guidebook/feature/forward-ref.html" class="sidebar-link">React.forwardRef</a></li><li><a href="/react-guidebook/feature/lazy.html" class="sidebar-link">React.lazy</a></li><li><a href="/react-guidebook/feature/suspense.html" class="sidebar-link">React.Suspense</a></li><li><a href="/react-guidebook/feature/clone-element.html" class="sidebar-link">React.cloneElement</a></li><li><a href="/react-guidebook/feature/is-valid-element.html" class="sidebar-link">React.isValidElement</a></li><li><a href="/react-guidebook/feature/children.html" class="sidebar-link">React.Children</a></li><li><a href="/react-guidebook/feature/force-update.html" class="sidebar-link">forceUpdate</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>生态</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>路由管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/ecosystem/routing/spa-routing.html" class="sidebar-link">单页面应用路由机制</a></li><li><a href="/react-guidebook/ecosystem/routing/react-router.html" class="sidebar-link">React Router</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>数据管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/ecosystem/redux/flux.html" class="sidebar-link">Flux</a></li><li><a href="/react-guidebook/ecosystem/redux/redux.html" class="sidebar-link">Redux</a></li><li><a href="/react-guidebook/ecosystem/redux/react-redux.html" class="sidebar-link">React Redux</a></li><li><a href="/react-guidebook/ecosystem/redux/redux-saga.html" class="sidebar-link">Redux Saga</a></li><li><a href="/react-guidebook/ecosystem/redux/redux-thunk.html" class="sidebar-link">Redux Thunk</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>类型检测</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-guidebook/ecosystem/type/prop-types.html" class="sidebar-link">PropTypes</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="virtual-dom"><a href="#virtual-dom" aria-hidden="true" class="header-anchor">#</a> Virtual DOM</h1> <blockquote><p>Virtual DOM 的本质是一个用来映射真实 DOM 的 JavaScript 对象</p></blockquote> <p>React 的 Virtual DOM，是存储于内存中的 JavaScript 对象，React 先将页面发生的变化更新到 Virtual DOM，每次的变化都和上次 Virtual DOM 的状态进行比较，找到变化的部分，最终 React 先将包含了所有变化的 Virtual DOM 与真实 DOM 进行比较，找到 DOM 发生变化的部分，一次性应用到真实 DOM 上。这样能有效减少浏览器的回流和重绘，以最少的代价渲染 DOM，实现最小化性能对资源池的操作，从而提高页面渲染速度与性能。</p> <h2 id="基本原理"><a href="#基本原理" aria-hidden="true" class="header-anchor">#</a> 基本原理</h2> <p>虚拟的 DOM 的核心思想是：对复杂的文档 DOM 结构，提供一种方便的工具，进行最小化地 DOM 操作。这句话，也许过于抽象，却基本概况了虚拟 DOM 的设计思想。</p> <p>使用 JavaScript 对象表示 DOM 信息和结构，当状态变更的时候，会重新渲染这个 JavaScript 的对象结构。</p> <p><strong>DOM 树的 JavaScript 对象表达</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 节点标签名</span>
    tagName<span class="token punctuation">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
    <span class="token comment">// DOM属性,用一个对象存储键值对</span>
    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token string">'list'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 该节点的子节点</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>tagName<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Item 1'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>tagName<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Item 2'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>tagName<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Item 3'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对应的 DOM 树中的 HTML 写法：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>反之亦然，你亦可以根据 JavaScript 对象来构建真正的 DOM 树。</p> <h2 id="算法实现"><a href="#算法实现" aria-hidden="true" class="header-anchor">#</a> 算法实现</h2> <p><strong>算法实现步骤：</strong></p> <ol><li>用 JavaScript 对象结构表示 DOM 树的结构；然后用这个树构建一个真正的 DOM 树，插到文档当中</li> <li>当状态变更的时候，重新构造一棵新的对象树。然后用新的树和旧的树进行比较，记录两棵树差异</li> <li>把步骤 2 所记录的差异应用到步骤 1 所构建的真正的 DOM 树上，视图就更新了</li></ol> <p><strong>功能拆分（React 中实际方法函数）</strong></p> <ol><li>一个生成虚拟 DOM 对象的 Javascript 函数（React.createElement）</li> <li>一个将虚拟 DOM 转换成真实 DOM 的函数</li> <li>一个解析模版节点的函数</li> <li>一个更新虚拟 DOM 新旧节点的函数</li> <li>一个对比虚拟 DOM 新旧节点的函数</li></ol> <h3 id="模拟-dom-树"><a href="#模拟-dom-树" aria-hidden="true" class="header-anchor">#</a> 模拟 DOM 树</h3> <p>用 JavaScript 来表示一个 DOM 节点是很简单的事情，你只需要记录它的<strong>节点类型</strong>、<strong>属性</strong>，还有<strong>子节点</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// element.js</span>
<span class="token keyword">function</span> <span class="token function">Element</span> <span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tagName <span class="token operator">=</span> tagName
  <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props
  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例如上面的 DOM 结构就可以简单的表示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> el <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./element'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> ul <span class="token operator">=</span> <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Item 1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Item 2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Item 3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>现在 <code>ul</code> 只是一个 JavaScript 对象表示的 DOM 结构，页面上并没有这个结构。我们可以根据这个 <code>ul</code> 构建真正的 <code>&lt;ul&gt;</code> 标签：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token comment">// 根据 tagName 构建</span>
    <span class="token keyword">var</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">creatElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tagName<span class="token punctuation">)</span>
    <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props
		
    <span class="token comment">// 设置节点的 DOM 属性</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> propValue <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> children <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 如果子节点也是虚拟 DOM，则递归构建 DOM 节点</span>
        <span class="token keyword">var</span> childEl <span class="token operator">=</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span>
        	<span class="token operator">?</span> child<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>					
        	<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>	<span class="token comment">// 如果字符串,只构建文本节点</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childEl<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> el
<span class="token punctuation">}</span>
</code></pre></div><p><code>render()</code> 方法会根据 <code>tagName</code> 构建一个真正的 DOM 节点，然后设置这个节点的属性，最后递归地把自己的子节点也构建起来。所以只需要：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ulRoot <span class="token operator">=</span> ul<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>ulRoot<span class="token punctuation">)</span>
</code></pre></div><p><code>ulRoot</code> 是真正的 DOM 节点，把它塞入文档中，这样的 <code>&lt;body&gt;</code> 里面就有了真正的 <code>&lt;ul&gt;</code> 的 DOM 结构。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Item3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>完整代码可见 <a href="https://github.com/livoras/simple-virtual-dom/blob/master/lib/element.js" target="_blank" rel="noopener noreferrer">element.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="判断差异"><a href="#判断差异" aria-hidden="true" class="header-anchor">#</a> 判断差异</h3> <p>既然我们已经通过 JavaScript 来模拟实现了 DOM，那么接下来的难点就在于<strong>如何判断旧的对象和新的对象之间的差异</strong>。</p> <p>DOM 是多叉树的结构，如果需要完整的对比两棵树的差异，那么需要的时间复杂度会是 <code>O(n^3)</code>，这个复杂度肯定是不能接受的。于是 React 团队优化了算法，实现了 <code>O(n)</code> 的复杂度来对比差异。</p> <p>实现 <code>O(n)</code> 复杂度的关键就是只对比同层的节点，而不是跨层对比，这也是考虑到在实际业务中很少会去跨层的移动 DOM 元素。</p> <p>所以判断差异的算法就分为了两步：</p> <ul><li>首先<strong>从上至下</strong>，<strong>从左往右</strong>遍历对象，也就是<span style="color:red;font-weight:bold;">树的深度优先遍历</span>，这一步中会给<strong>每个节点添加索引</strong>，便于最后渲染差异（同层节点进行比较的常用方法）</li> <li>一旦节点有子元素，就去判断子元素是否有不同</li></ul> <p><img src="/react-guidebook/assets/img/virtual_dom_1.262384a1.jpg" alt="VirtualDOM：同层级元素比对"></p> <p><img src="/react-guidebook/assets/img/virtual_dom_2.6ec96ca4.jpg" alt="深度优先遍历，记录差异"></p> <h4 id="树的递归"><a href="#树的递归" aria-hidden="true" class="header-anchor">#</a> 树的递归</h4> <p>首先我们来实现树的递归算法，在实现该算法前，先来考虑下两个节点对比会有几种情况</p> <ol><li>新的节点的 <code>tagName</code> 或者 <code>key</code> 和旧的节点不同，这种情况代表需要替换旧的节点，并且也不再需要遍历新旧节点的子元素了，因为整个旧节点都被删掉了</li> <li>新的节点的 <code>tagName</code> 和 <code>key</code>（可能都没有）和旧的节点相同，开始遍历子树</li> <li>没有新的节点，那么什么都不用做</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> stateEnums<span class="token punctuation">,</span> isString<span class="token punctuation">,</span> move <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>
<span class="token keyword">import</span> Element <span class="token keyword">from</span> <span class="token string">'./element'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">olaDOMTree<span class="token punctuation">,</span> newDOMTree</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 用于记录差异</span>
    <span class="token keyword">let</span> patches <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 一开始的索引为 0</span>
    <span class="token function">dfs</span><span class="token punctuation">(</span>oldDOMTree<span class="token punctuation">,</span> newDOMTree<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
    <span class="token keyword">return</span> patches
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 用于保存子树的更改</span>
    <span class="token keyword">let</span> currentPatches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 需要判断三种情况</span>
    <span class="token comment">// 1. 没有新的节点，那么什么都不做</span>
    <span class="token comment">// 2. 新的节点的 tagName 和 key 和旧的节点不同，就替换</span>
    <span class="token comment">// 3. 新的节点的 tagName 和 key（可能都没有）和旧的节点相同，开始遍历子树</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newNode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode <span class="token operator">&amp;&amp;</span> newNode<span class="token punctuation">.</span>tag <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> newNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 判断属性是否变更</span>
        <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">diffProps</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
            currentPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">,</span> props <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">diffChildren</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 节点不同，需要替换</span>
        currentPatches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">,</span> node<span class="token punctuation">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPathces<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>currentPathces<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> currentPatches
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="判断属性的更改"><a href="#判断属性的更改" aria-hidden="true" class="header-anchor">#</a> 判断属性的更改</h4> <p>判断属性的更改也分为三个步骤：</p> <ol><li>遍历旧的属性列表，查看每个属性<strong>是否还存在于新的属性列表</strong>中</li> <li>遍历新的属性列表，判断两个列表中<strong>都存在的属性的值是否有变化</strong></li> <li>在第二步中同时查看是否有属性不存在于旧的属性列表中</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 判断 Props 分以下三步骤</span>
  	<span class="token comment">// 先遍历 oldProps 查看是否存在删除的属性</span>
  	<span class="token comment">// 然后遍历 newProps 查看是否有属性值被修改</span>
  	<span class="token comment">// 最后查看是否有属性新增</span>
    <span class="token keyword">let</span> change <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                prop<span class="token punctuation">:</span> keyd
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> prop <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    props<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
                    value<span class="token punctuation">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                change<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    prop<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
                    value<span class="token punctuation">:</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> change
<span class="token punctuation">}</span>
</code></pre></div><h4 id="判断列表差异算法实现"><a href="#判断列表差异算法实现" aria-hidden="true" class="header-anchor">#</a> 判断列表差异算法实现</h4> <p>这个算法是整个 Virtual Dom 中最核心的算法。 这里的主要步骤其实和判断属性差异是类似的，也是分为三步：</p> <ol><li>遍历旧的节点列表，查看每个节点是否还存在于新的节点列表中</li> <li>遍历新的节点列表，判断是否有新的节点</li> <li>在第二步中同时判断节点是否有移动</li></ol> <p>⚠️ <strong>注意</strong>：该算法只对有 <code>key</code> 的节点做处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">listDiff</span><span class="token punctuation">(</span><span class="token parameter">oldList<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 为了遍历方便，先取出两个 list 的所有 keys</span>
 <span class="token keyword">let</span> oldKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>oldList<span class="token punctuation">)</span>
 <span class="token keyword">let</span> newKeys <span class="token operator">=</span> <span class="token function">getKeys</span><span class="token punctuation">(</span>newList<span class="token punctuation">)</span>
 <span class="token keyword">let</span> changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

 <span class="token comment">// 用于保存变更后的节点数据</span>
 <span class="token comment">// 使用该数组保存有以下好处</span>
 <span class="token comment">// 1.可以正确获得被删除节点索引</span>
 <span class="token comment">// 2.交换节点位置只需要操作一遍 DOM</span>
 <span class="token comment">// 3.用于 `diffChildren` 函数中的判断，只需要遍历</span>
 <span class="token comment">// 两个树中都存在的节点，而对于新增或者删除的节点来说，完全没必要</span>
 <span class="token comment">// 再去判断一遍</span>
 <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 oldList <span class="token operator">&amp;&amp;</span>
   oldList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       key <span class="token operator">=</span> item
     <span class="token punctuation">}</span>
     <span class="token comment">// 寻找新的 children 中是否含有当前节点</span>
     <span class="token comment">// 没有的话需要删除</span>
     <span class="token keyword">let</span> index <span class="token operator">=</span> newKeys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token comment">// 遍历变更后的数组</span>
 <span class="token keyword">let</span> length <span class="token operator">=</span> list<span class="token punctuation">.</span>length
 <span class="token comment">// 因为删除数组元素是会更改索引的</span>
 <span class="token comment">// 所有从后往前删可以保证索引不变</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 判断当前元素是否为空，为空表示需要删除</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
     changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">,</span>
       index<span class="token punctuation">:</span> i
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 遍历新的 list，判断是否有节点新增或移动</span>
 <span class="token comment">// 同时也对 `list` 做节点新增和移动节点的操作</span>
 newList <span class="token operator">&amp;&amp;</span>
   newList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       key <span class="token operator">=</span> item
     <span class="token punctuation">}</span>
     <span class="token comment">// 寻找旧的 children 中是否含有当前节点</span>
     <span class="token keyword">let</span> index <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
     <span class="token comment">// 没找到代表新节点，需要插入</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">,</span>
         node<span class="token punctuation">:</span> item<span class="token punctuation">,</span>
         index<span class="token punctuation">:</span> i
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
       list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token comment">// 找到了，需要判断是否需要移动</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
           type<span class="token punctuation">:</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">,</span>
           <span class="token keyword">from</span><span class="token punctuation">:</span> index<span class="token punctuation">,</span>
           to<span class="token punctuation">:</span> i
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token function">move</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> index<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token keyword">return</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 <span class="token keyword">let</span> text
 list <span class="token operator">&amp;&amp;</span>
   list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> key
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       key <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">]</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       key <span class="token operator">=</span> item<span class="token punctuation">.</span>key
     <span class="token punctuation">}</span>
     keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token keyword">return</span> keys
<span class="token punctuation">}</span>
</code></pre></div><h4 id="遍历子元素打标识"><a href="#遍历子元素打标识" aria-hidden="true" class="header-anchor">#</a> 遍历子元素打标识</h4> <p>对于这个函数来说，主要功能就两个</p> <ol><li>判断两个列表差异</li> <li>给节点打上标记</li></ol> <p>总体来说，该函数实现的功能很简单</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> changes<span class="token punctuation">,</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">listDiff</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> changes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 记录上一个遍历过的节点</span>
  <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
  oldChild <span class="token operator">&amp;&amp;</span>
    oldChild<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> item <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>children
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">=</span>
          last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">let</span> keyIndex <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token keyword">let</span> node <span class="token operator">=</span> newChild<span class="token punctuation">[</span>keyIndex<span class="token punctuation">]</span>
        <span class="token comment">// 只遍历新旧中都存在的节点，其他新增或者删除的没必要遍历</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">dfs</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> node<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> index <span class="token operator">+=</span> <span class="token number">1</span>
      last <span class="token operator">=</span> item
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="渲染差异"><a href="#渲染差异" aria-hidden="true" class="header-anchor">#</a> 渲染差异</h4> <p>通过之前的算法，我们已经可以得出两个树的差异了。既然知道了差异，就需要局部去更新 DOM 了，下面就让我们来看看 Virtual DOM 算法的最后一步骤：</p> <p>这个函数主要两个功能</p> <ol><li>深度遍历树，将需要做变更操作的取出来</li> <li>局部更新 DOM</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patchs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">let</span> changes <span class="token operator">=</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
 <span class="token keyword">let</span> childNodes <span class="token operator">=</span> node <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes
 <span class="token comment">// 这里的深度遍历和 diff 中是一样的</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childNodes<span class="token punctuation">)</span> index <span class="token operator">+=</span> <span class="token number">1</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">&amp;&amp;</span> changes<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> patchs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">changeDom</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> changes<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">let</span> last <span class="token operator">=</span> <span class="token keyword">null</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>childNodes <span class="token operator">&amp;&amp;</span> childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     index <span class="token operator">=</span>
       last <span class="token operator">&amp;&amp;</span> last<span class="token punctuation">.</span>children <span class="token operator">?</span> index <span class="token operator">+</span> last<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
     <span class="token function">patch</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> patchs<span class="token punctuation">)</span>
     last <span class="token operator">=</span> item
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">changeDom</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> changes<span class="token punctuation">,</span> noChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 changes <span class="token operator">&amp;&amp;</span>
   changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">change</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> change
     <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>ChangeProps<span class="token punctuation">:</span>
         <span class="token keyword">let</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> change
         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">,</span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>prop<span class="token punctuation">)</span>
           <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span>
       <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Remove<span class="token punctuation">:</span>
         node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span>
       <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Insert<span class="token punctuation">:</span>
         <span class="token keyword">let</span> dom
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           dom <span class="token operator">=</span> change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         node<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token keyword">break</span>
       <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Replace<span class="token punctuation">:</span>
         node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span>
         <span class="token keyword">break</span>
       <span class="token keyword">case</span> StateEnums<span class="token punctuation">.</span>Move<span class="token punctuation">:</span>
         <span class="token keyword">let</span> fromNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>from<span class="token punctuation">]</span>
         <span class="token keyword">let</span> toNode <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>change<span class="token punctuation">.</span>to<span class="token punctuation">]</span>
         <span class="token keyword">let</span> cloneFromNode <span class="token operator">=</span> fromNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
         <span class="token keyword">let</span> cloenToNode <span class="token operator">=</span> toNode<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
         node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloneFromNode<span class="token punctuation">,</span> toNode<span class="token punctuation">)</span>
         node<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>cloenToNode<span class="token punctuation">,</span> fromNode<span class="token punctuation">)</span>
         <span class="token keyword">break</span>
       <span class="token keyword">default</span><span class="token punctuation">:</span>
         <span class="token keyword">break</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="算法实现总结"><a href="#算法实现总结" aria-hidden="true" class="header-anchor">#</a> 算法实现总结</h3> <p>Virtual DOM 算法主要是实现上面步骤的三个函数：<a href="https://link.zhihu.com/?target=https%3A//github.com/livoras/simple-virtual-dom/blob/master/lib/element.js" target="_blank" rel="noopener noreferrer">element<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="https://link.zhihu.com/?target=https%3A//github.com/livoras/simple-virtual-dom/blob/master/lib/diff.js" target="_blank" rel="noopener noreferrer">diff<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="https://link.zhihu.com/?target=https%3A//github.com/livoras/simple-virtual-dom/blob/master/lib/patch.js" target="_blank" rel="noopener noreferrer">patch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。然后就可以实际的进行使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1. 构建虚拟DOM</span>
<span class="token keyword">var</span> tree <span class="token operator">=</span> <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'container'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token punctuation">:</span> <span class="token string">'color: blue'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'simple virtal dom'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hello, virtual-dom'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 2. 通过虚拟 DOM 构建真正的 DOM</span>
<span class="token keyword">var</span> root <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>

<span class="token comment">// 3. 生成新的虚拟 DOM</span>
<span class="token keyword">var</span> newTree <span class="token operator">=</span> <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'container'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token punctuation">:</span> <span class="token string">'color: red'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'simple virtal dom'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hello, virtual-dom'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">el</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 4. 比较两棵虚拟DOM树的不同</span>
<span class="token keyword">var</span> patches <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> newTree<span class="token punctuation">)</span>

<span class="token comment">// 5. 在真正的DOM元素上应用变更</span>
<span class="token function">patch</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
</code></pre></div><h2 id="特点"><a href="#特点" aria-hidden="true" class="header-anchor">#</a> 特点</h2> <p>优点：最终表现在 DOM 上的修改只是变更的部分，可以保证非常高效的渲染。</p> <p>缺点：首次渲染大量 DOM 时，由于多了一层虚拟 DOM 的计算，会比 innerHTML 插入慢。</p> <p>一些轻量级 Virtual DOM 的实现：</p> <ul><li><a href="https://github.com/HolyZheng/holyZheng-blog/issues/14" target="_blank" rel="noopener noreferrer">hoz<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://ewind.us/2017/nano-vdom/" target="_blank" rel="noopener noreferrer">Yifeng Wang<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <hr> <p><strong>参考资料：</strong></p> <ul><li><a href="https://reactjs.org/docs/faq-internals.html" target="_blank" rel="noopener noreferrer">Virtual DOM and Internals<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zhihu.com/question/29504639?sort=created" target="_blank" rel="noopener noreferrer">知乎：如何理解虚拟 DOM?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/entry/5857482a61ff4b0063c80d4d" target="_blank" rel="noopener noreferrer">掘金：深入研究 Virtual DOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5b10dd36e51d4506e04cf802#heading-3" target="_blank" rel="noopener noreferrer">掘金：深入框架本源系列<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://sq.163yun.com/blog/article/183677505940332544" target="_blank" rel="noopener noreferrer">网易云：从零开始创建 VirtualDOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://calendar.perfplanet.com/2013/diff/" target="_blank" rel="noopener noreferrer">React‘s diff algorithm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/@rajaraodv/the-inner-workings-of-virtual-dom-666ee7ad47cf" target="_blank" rel="noopener noreferrer">The Inner Working Of Virtual DOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间: </span> <span class="time">7/19/2019, 3:40:31 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react-guidebook/core/fiber.html" class="prev">
          Fiber
        </a></span> <span class="next"><a href="/react-guidebook/core/diffing-algorithm.html">
          差异化算法
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/react-guidebook/assets/js/app.260c1e95.js" defer></script><script src="/react-guidebook/assets/js/2.faf5b053.js" defer></script><script src="/react-guidebook/assets/js/6.38cc656d.js" defer></script>
  </body>
</html>
